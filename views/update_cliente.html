<!-- AQUI EL CLIENTE SOLO OBSERVA Y JUEGA UNA VEZ ENVIA EL REPORTE
    HABRA UNA FUNCION PARA CAMBIAR LAS FASES
    FASES:
        + ESPERANDO VALIDACION (UNA VEZ ENVIADO EL FORM. Y ES RECIBIDO POR EL ADMIN)
        + VALIDACION ACEPTADA (UNA VEZ EL ADMIN HAYA ELEGIDO EL TECNICO Y ENVIARSELO)
        + TECNICO EN CAMINO (UNA VEZ EL TECNICO PRESIONA EL BOTON DE ACEPTAR REPORTE)
        + TRABAJO EN PROCESO (UNA VEZ EL TEC. PRECIONE EL BOTON DE INICIAR TRABAJO (OPCIONES QUE TENDRA EL TEC. EN SU UPDATE))
        + TRABAJO TERMINADO (UNA VEZ EL TEC. PRESIONE EL BOTON DE FINALIZAR TRABAJO)
    (CUENDO EL TECNICO HAYA TERMINADO EL TRABAJO SE LE ENVIARA A SU FORMULARIO)  

    ELIMINAR NAV Y FOOTER PARA UTILIZAR PLANTILLA
        -->

        <!DOCTYPE html>
        <html lang="es">
        
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="description" content="Confirmación de Reporte">
            <title>Confirmación de Reporte</title>
        
            <!-- Bootstrap CSS -->
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
            <!-- Leaflet CSS para el mapa -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
            <!-- Tu archivo CSS personalizado -->
            <link rel="stylesheet" href="styles.css">
            <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        
        
            <style>
                /* Estilos adicionales para la vista de confirmación */
                .status-section {
                    background-color: #1c3d6e;
                    padding: 20px;
                    border-radius: 10px;
                    text-align: center;
                    margin-bottom: 20px;
                    color: white;
                }
        
                #map {
                    height: 400px;
                    width: 100%;
                    border-radius: 10px;
                }
        
                h1, h2 {
                    color: #343a40;
                }
        
                .status-section h2 {
                    color: white;
                }
            </style>
                <style>
                /* Estilo del contenedor del mapa */
                #map { width: 100%; height: 600px; } 
        
                /* Estilo de los popups con gráficos */
                .chart-popup { width: 300px; height: 300px; } 
                .chart-container { width: 100%; height: 100%; }
            </style>
            
        
        </head>
        
        <body>
            <!-- NAVBAR -->
            <header>
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container">
                        <a class="navbar-brand" href="#">Luz Alerta</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav ms-auto">
                                <li class="nav-item">
                                    <a class="nav-link" href="iniciocliente.html">Inicio</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="../includes/QuieneSomos.html">¿Quiénes somos?</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="../includes/Contactanos.html">Contacto</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </header>
        
            <!-- Contenido Principal -->
            <div class="container my-4">
                <section class="text-center mb-4">
                    <h1>Confirmación de Reporte</h1>
                    <p>Su reporte ha sido recibido exitosamente. A continuación puede ver los detalles de su solicitud.</p>
                </section>
        
                <!-- Sección de estado -->
                <div class="status-section">
                    <h2>Estado de la solicitud:</h2>
                    <p>Trabajador asignado al reporte</p>
                    <p>Tiempo estimado para la llegada: 45 min</p>
                </div>
        
                <!-- Mapa dinámico de la zona del reporte -->
                <div id="map"></div>
                </div>
                <div class="text-center my-4">
                    <a href="../assets/juego.html" target="_blank" class="btn btn-primary">Jugar Minijuego</a>
                </div>
                
            <!-- Pie de Página -->
          <!-- Footer -->
        <footer class="bg-dark text-white py-3 mt-auto">
            <div class="container">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                  <p class="mb-2 mb-md-0">&copy; 2024 LuzAlerta_. Todos los derechos reservados.</p>
        
                    <!-- Iconos de Redes Sociales -->
                    <div>
                        <a href="https://facebook.com" target="_blank" class="text-white mx-2"><i class="fab fa-facebook fa-lg"></i></a>
                        <a href="https://twitter.com" target="_blank" class="text-white mx-2"><i class="fab fa-twitter fa-lg"></i></a>
                        <a href="https://instagram.com" target="_blank" class="text-white mx-2"><i class="fab fa-instagram fa-lg"></i></a>
                    </div>
                
                    <!-- Botón para abrir el modal -->
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalReglamento">
                        Reglamento y Modo de Uso
                    </button>
                    
                </div>
            </div>
        </footer>
        
        <!-- Modal -->
        <div class="modal fade" id="modalReglamento" tabindex="-1" aria-labelledby="modalReglamentoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalReglamentoLabel">Reglamento y Modo de Uso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Contenido Original -->
                        <div class="container">
                            <h1>Reglamento y Modo de Uso</h1>
        
                            <div class="section">
                                <h2>1. Normas generales</h2>
                                <p>- Todos los usuarios deben registrarse con información verídica y actualizada.</p>
                                <p>- El acceso a la aplicación está limitado a usuarios debidamente autorizados.</p>
                                <p>- Se debe respetar la confidencialidad de las credenciales de acceso.</p>
                                <p>- Está prohibido compartir contraseñas o cuentas con terceros.</p>
                                <p>- Los usuarios deben utilizar la aplicación únicamente para los fines previstos (por ejemplo, reportar fallos, consultar facturas, solicitar servicios técnicos).</p>
                                <p>- Está prohibido utilizar la plataforma para actividades fraudulentas o ilegales.</p>
                            </div>
        
                            <div class="section">
                                <h2>2. Modo de Uso</h2>
                                <p>- En caso de tener una cuenta debes loguearte; caso contrario deberás registrarte para poder acceder.</p>
                                <p>- Acto seguido verás una vista con un formulario y un mapa. Deberás rellenar el formulario de emergencia para informar a la empresa.</p>
                                <p>- Luego de informar podrás ver una pantalla de actualización en la que se verá tu ubicación marcada en el mapa.</p>
                                <p>- Al finalizar la emergencia se te notificará, y podrás salir de la aplicación habiendo colaborado con la reparación del suministro eléctrico.</p>
                            </div>
        
                            <div class="section">
                                <h2>3. Política de Emergencias</h2>
                                <p>Se considera emergencia cualquier situación que afecte o amenace la seguridad de las personas, propiedades, infraestructura eléctrica, o el medio ambiente. Ejemplos incluyen:</p>
                                <ul>
                                    <li>Corte eléctrico total o parcial en áreas residenciales, comerciales o industriales.</li>
                                    <li>Riesgo de electrocución por cables caídos o expuestos.</li>
                                    <li>Sobrecalentamiento de transformadores o estaciones de servicio.</li>
                                    <li>Incendios asociados a la red eléctrica.</li>
                                    <li>Fallas críticas en hospitales, estaciones de policía, bomberos, u otras instalaciones vitales.</li>
                                </ul>
                            </div>
        
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" data-bs-dismiss="modal">He leído y acepto</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scripts de Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        
        </body>
        </html>
        
        
            <!-- Scripts de Bootstrap y Leaflet -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        
            <script>
                // Inicializa el mapa centrado en Temuco con un nivel de zoom de 12
                const map = L.map('map').setView([-38.73965, -72.59842], 12);
        
                // Agrega la capa base del mapa usando OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
        
                // Cargar las zonas de prioridad desde un archivo GeoJSON externo
                fetch('../assets/Prioridades.geojson')
                    .then(response => response.json())  // Convertir la respuesta a JSON
                    .then(data => {
                        // Agregar las zonas de prioridad al mapa
                        L.geoJSON(data, {
                            style: feature => ({
                                // Asignar colores según la prioridad
                                color: feature.properties.prioridad === 'alta' ? 'red' :
                                       feature.properties.prioridad === 'media' ? 'orange' : 'green'
                            })
                        }).addTo(map);  // Añadir las zonas al mapa
                    });
        
                // Datos para los gráficos asociados a cada ícono
                const chartData = {
                    'AvAlemania': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [55, 10, 15, 20] },
                    'Centro': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [10, 20, 30, 40] },
                    'AvBarros': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [0, 10, 20, 70] },
                    'Venecia': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [50, 50, 0, 0] },
                    'PedroValdivia': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [70, 30, 0, 0] },
                    'FundoCarmen': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [40, 20, 0, 40] },
                    'labranza': { labels: ['Hospitales', 'Alta población', 'Comercio', 'Serv. Emergencias'], data: [45, 5, 5, 45] }
                };
        
                // Definición de los íconos personalizados
                const icons = {
                    Hospital: L.icon({ iconUrl: '../assets/medicamento.png', iconSize: [22, 22], iconAnchor: [16, 32] }),
                    Emergencia: L.icon({ iconUrl: '../assets/policia.png', iconSize: [22, 22], iconAnchor: [16, 32] })
                };
        
                // Lista de marcadores con sus coordenadas y tipo de ícono
                const markers = [
                    { coords: [-38.735, -72.612], type: 'Hospital', dataKey: 'AvAlemania' },
                    { coords: [-38.741, -72.5886], type: 'Emergencia', dataKey: 'Centro' },
                    { coords: [-38.73251, -72.573499], type: 'Emergencia', dataKey: 'AvBarros' },
                    { coords: [-38.7576864, -72.622622], type: 'Hospital', dataKey: 'Venecia' },
                    { coords: [-38.7121813, -72.62405], type: 'Hospital', dataKey: 'PedroValdivia' },
                    { coords: [-38.7120641, -72.653935], type: 'Hospital', dataKey: 'FundoCarmen' },
                    { coords: [-38.7630844, -72.749384697], type: 'Hospital', dataKey: 'labranza' }
                ];
        
                // Añadir cada marcador al mapa y asociar su gráfico correspondiente
                markers.forEach(({ coords, type, dataKey }) => {
                    L.marker(coords, { icon: icons[type] })
                        .addTo(map)
                        .on('click', e => mostrarGrafico(dataKey, e.latlng));
                });
        
                // Función para mostrar gráficos al hacer clic en un ícono
                function mostrarGrafico(tipo, latlng) {
                    const data = chartData[tipo];  // Obtener los datos correspondientes
                    const popupContent = `
                        <div class="chart-popup">
                            <canvas id="chart-${tipo}" class="chart-container"></canvas>
                        </div>`;
                    
                    // Abrir un popup en la posición del ícono
                    L.popup()
                        .setLatLng(latlng)
                        .setContent(popupContent)
                        .openOn(map);
        
                    // Esperar un momento para asegurarse que el canvas está disponible
                    setTimeout(() => {
                        const ctx = document.getElementById(`chart-${tipo}`).getContext('2d');
                        // Crear el gráfico usando Chart.js
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: data.labels,
                                datasets: [{ data: data.data, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#00C040'] }]
                            },
                            options: { responsive: true }
                        });
                    }, 300);
                }
                // Ruta predefinida para el marcador en movimiento
        const route = [
            [-38.73965, -72.59842],
            [-38.735, -72.612],
            [-38.738, -72.615],
            [-38.740, -72.618],
            [-38.745, -72.620],
            [-38.750, -72.625]
        ];

        // Crear el marcador en movimiento
        let movingMarker = L.marker(route[0], {
            icon: L.icon({
                iconUrl: '../assets/pollata.png', // Cambia este ícono a uno que desees
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            })
        }).addTo(map);

        // Índice para recorrer la ruta
        let smoothIndex = 0;
        let step = 0.1; // Paso para interpolación (menor valor = más suave)

        // Función para interpolar entre dos coordenadas
        function interpolate(lat1, lng1, lat2, lng2, factor) {
            return [
                lat1 + (lat2 - lat1) * factor,
                lng1 + (lng2 - lng1) * factor
            ];
        }

        // Función para mover el marcador suavemente
        function smoothMoveMarker() {
            if (smoothIndex >= route.length - 1) {
                smoothIndex = 0; // Reinicia el índice cuando termine la ruta
            }

            const current = route[smoothIndex];
            const next = route[smoothIndex + 1];

            // Calcula la nueva posición
            const newPosition = interpolate(current[0], current[1], next[0], next[1], step);

            // Actualiza la posición del marcador
            movingMarker.setLatLng(newPosition);

            // Incrementa el paso
            step += 0.1;
            if (step >= 1) {
                step = 0;
                smoothIndex++; // Avanza al siguiente punto de la ruta
            }
        }

        // Mueve el marcador cada 100 ms
        setInterval(smoothMoveMarker, 100);
                // Evento para capturar y mostrar las coordenadas al hacer clic en el mapa
                //map.on('click', e => {
                  //  console.log(`Latitud: ${e.latlng.lat}, Longitud: ${e.latlng.lng}`);
                    //L.popup()
                        //.setLatLng(e.latlng)
                        //.setContent(`Coordenadas: ${e.latlng.lat}, ${e.latlng.lng}`)
                        //.openOn(map);
                //});
            </script>
            
            
        
        </body>
        
        </html>
        